-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--
--       â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
--       â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•
--       â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
--       â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘
--       â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
--       â•šâ•â•â•šâ•â•  â•šâ•â•â•â•  â•šâ•â•â•â•  â•šâ•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•   â•šâ•â•   â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â•
--
--                    SYSTÃˆME D'INVITATION - ATÂ·OM / CHEÂ·NU V76
--              Points de LumiÃ¨re Internationaux - Membres Fondateurs
--
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--
-- INSTRUCTIONS:
-- 1. ExÃ©cutez ce script APRÃˆS supabase-security.sql
-- 2. Ce script ajoute le systÃ¨me d'invitation pour les membres fondateurs
--
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- 1. TABLE DES INVITATIONS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE IF NOT EXISTS invitations (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,

  -- Code d'invitation unique (ex: ATOM-LIGHT-7X9K)
  code TEXT UNIQUE NOT NULL,

  -- Informations sur l'invitÃ©
  invited_name TEXT NOT NULL,
  invited_email TEXT,
  personal_message TEXT,

  -- Type de membre fondateur
  founder_type TEXT DEFAULT 'lumiere' CHECK (founder_type IN (
    'lumiere',       -- Point de LumiÃ¨re International
    'gardien',       -- Gardien de l'Arche
    'architecte',    -- Architecte de Civilisation
    'tisserand',     -- Tisserand de Liens
    'porteur'        -- Porteur de Flamme
  )),

  -- Contribution Ã©nergÃ©tique reconnue
  contribution_note TEXT,

  -- Statut de l'invitation
  status TEXT DEFAULT 'pending' CHECK (status IN (
    'pending',       -- En attente d'utilisation
    'accepted',      -- AcceptÃ©e et compte crÃ©Ã©
    'expired',       -- ExpirÃ©e
    'revoked'        -- RÃ©voquÃ©e
  )),

  -- Utilisateur qui a acceptÃ© l'invitation
  accepted_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  accepted_at TIMESTAMP WITH TIME ZONE,

  -- MÃ©tadonnÃ©es
  created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  expires_at TIMESTAMP WITH TIME ZONE DEFAULT (NOW() + INTERVAL '30 days'),

  -- Limites d'utilisation
  max_uses INTEGER DEFAULT 1,
  use_count INTEGER DEFAULT 0
);

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- 2. TABLE DES MEMBRES FONDATEURS (Extension du profil)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE IF NOT EXISTS founders (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE NOT NULL,

  -- Invitation utilisÃ©e
  invitation_id UUID REFERENCES invitations(id) ON DELETE SET NULL,

  -- Type de fondateur (hÃ©ritÃ© de l'invitation)
  founder_type TEXT NOT NULL,

  -- NumÃ©ro de fondateur (ordre d'arrivÃ©e)
  founder_number INTEGER,

  -- Informations personnelles partagÃ©es
  location_country TEXT,
  location_city TEXT,
  timezone TEXT,

  -- PrÃ©sentation
  story TEXT,                    -- Histoire personnelle / parcours
  intention TEXT,                -- Intention dans la communautÃ©
  gifts TEXT[],                  -- Dons/talents Ã  partager
  seeking TEXT[],                -- Ce qu'ils cherchent

  -- RÃ©sonance
  resonance_frequency INTEGER DEFAULT 444,
  spirit_animal TEXT,
  element TEXT CHECK (element IN ('feu', 'eau', 'terre', 'air', 'ether')),

  -- ActivitÃ©
  is_active BOOLEAN DEFAULT true,
  last_seen_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  -- MÃ©tadonnÃ©es
  joined_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- 3. TABLE DES CONNEXIONS ENTRE FONDATEURS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE IF NOT EXISTS founder_connections (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,

  -- Les deux fondateurs connectÃ©s
  founder_a UUID REFERENCES founders(user_id) ON DELETE CASCADE NOT NULL,
  founder_b UUID REFERENCES founders(user_id) ON DELETE CASCADE NOT NULL,

  -- Type de connexion
  connection_type TEXT DEFAULT 'resonance' CHECK (connection_type IN (
    'resonance',     -- Connexion Ã©nergÃ©tique
    'collaboration', -- Projet commun
    'mentorship',    -- Mentorat
    'friendship'     -- AmitiÃ©
  )),

  -- Note sur la connexion
  note TEXT,

  -- Statut
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'accepted', 'declined')),

  -- Qui a initiÃ©
  initiated_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,

  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  -- Ã‰viter les doublons
  UNIQUE(founder_a, founder_b),
  CHECK (founder_a < founder_b) -- Assure l'ordre pour Ã©viter les doublons inversÃ©s
);

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- 4. TABLE DES MESSAGES COMMUNAUTAIRES (Cercle des Fondateurs)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE IF NOT EXISTS founder_messages (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,

  -- Auteur
  author_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- Contenu
  content TEXT NOT NULL,

  -- Type de message
  message_type TEXT DEFAULT 'sharing' CHECK (message_type IN (
    'sharing',       -- Partage gÃ©nÃ©ral
    'gratitude',     -- Expression de gratitude
    'intention',     -- DÃ©claration d'intention
    'celebration',   -- CÃ©lÃ©bration
    'support',       -- Demande/offre de soutien
    'announcement'   -- Annonce importante
  )),

  -- RÃ©ponse Ã  un autre message
  reply_to UUID REFERENCES founder_messages(id) ON DELETE SET NULL,

  -- RÃ©actions (stockÃ©es comme JSON pour flexibilitÃ©)
  reactions JSONB DEFAULT '{}',

  -- VisibilitÃ©
  is_pinned BOOLEAN DEFAULT false,

  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- 5. ACTIVER RLS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ALTER TABLE invitations ENABLE ROW LEVEL SECURITY;
ALTER TABLE founders ENABLE ROW LEVEL SECURITY;
ALTER TABLE founder_connections ENABLE ROW LEVEL SECURITY;
ALTER TABLE founder_messages ENABLE ROW LEVEL SECURITY;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- 6. POLICIES POUR INVITATIONS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Seul le Souverain peut voir toutes les invitations
CREATE POLICY "Souverain can view all invitations"
  ON invitations FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'souverain'
    )
  );

-- Les utilisateurs peuvent voir leur propre invitation (via le code)
CREATE POLICY "Users can view invitation by code"
  ON invitations FOR SELECT
  USING (accepted_by = auth.uid());

-- Seul le Souverain peut crÃ©er des invitations
CREATE POLICY "Souverain can create invitations"
  ON invitations FOR INSERT
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'souverain'
    )
  );

-- Seul le Souverain peut modifier les invitations
CREATE POLICY "Souverain can update invitations"
  ON invitations FOR UPDATE
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'souverain'
    )
  );

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- 7. POLICIES POUR FONDATEURS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Tous les fondateurs peuvent voir les autres fondateurs
CREATE POLICY "Founders can view all founders"
  ON founders FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM founders f
      WHERE f.user_id = auth.uid()
    )
    OR
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'souverain'
    )
  );

-- Les fondateurs peuvent modifier leur propre profil
CREATE POLICY "Founders can update own profile"
  ON founders FOR UPDATE
  USING (user_id = auth.uid())
  WITH CHECK (user_id = auth.uid());

-- Insertion gÃ©rÃ©e par fonction sÃ©curisÃ©e
CREATE POLICY "System can insert founders"
  ON founders FOR INSERT
  WITH CHECK (user_id = auth.uid());

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- 8. POLICIES POUR CONNEXIONS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Les fondateurs peuvent voir leurs connexions
CREATE POLICY "Founders can view connections"
  ON founder_connections FOR SELECT
  USING (
    founder_a = auth.uid() OR founder_b = auth.uid()
    OR EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'souverain'
    )
  );

-- Les fondateurs peuvent crÃ©er des connexions
CREATE POLICY "Founders can create connections"
  ON founder_connections FOR INSERT
  WITH CHECK (
    initiated_by = auth.uid()
    AND EXISTS (SELECT 1 FROM founders WHERE user_id = auth.uid())
  );

-- Les fondateurs peuvent modifier leurs connexions
CREATE POLICY "Founders can update own connections"
  ON founder_connections FOR UPDATE
  USING (founder_a = auth.uid() OR founder_b = auth.uid());

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- 9. POLICIES POUR MESSAGES
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Tous les fondateurs peuvent voir les messages
CREATE POLICY "Founders can view messages"
  ON founder_messages FOR SELECT
  USING (
    EXISTS (SELECT 1 FROM founders WHERE user_id = auth.uid())
    OR EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'souverain'
    )
  );

-- Les fondateurs peuvent crÃ©er des messages
CREATE POLICY "Founders can create messages"
  ON founder_messages FOR INSERT
  WITH CHECK (
    author_id = auth.uid()
    AND EXISTS (SELECT 1 FROM founders WHERE user_id = auth.uid())
  );

-- Les fondateurs peuvent modifier leurs propres messages
CREATE POLICY "Founders can update own messages"
  ON founder_messages FOR UPDATE
  USING (author_id = auth.uid());

-- Les fondateurs peuvent supprimer leurs propres messages
CREATE POLICY "Founders can delete own messages"
  ON founder_messages FOR DELETE
  USING (author_id = auth.uid());

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- 10. FONCTIONS SÃ‰CURISÃ‰ES
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Fonction pour valider et utiliser un code d'invitation
CREATE OR REPLACE FUNCTION use_invitation_code(invitation_code TEXT)
RETURNS JSONB AS $$
DECLARE
  inv RECORD;
  founder_num INTEGER;
  result JSONB;
BEGIN
  -- Trouver l'invitation
  SELECT * INTO inv FROM invitations
    WHERE code = invitation_code
    AND status = 'pending'
    AND (expires_at IS NULL OR expires_at > NOW())
    AND use_count < max_uses;

  IF inv IS NULL THEN
    RETURN jsonb_build_object(
      'success', false,
      'error', 'Code d''invitation invalide, expirÃ© ou dÃ©jÃ  utilisÃ©'
    );
  END IF;

  -- VÃ©rifier si l'utilisateur n'est pas dÃ©jÃ  fondateur
  IF EXISTS (SELECT 1 FROM founders WHERE user_id = auth.uid()) THEN
    RETURN jsonb_build_object(
      'success', false,
      'error', 'Vous Ãªtes dÃ©jÃ  membre fondateur'
    );
  END IF;

  -- Calculer le numÃ©ro de fondateur
  SELECT COALESCE(MAX(founder_number), 0) + 1 INTO founder_num FROM founders;

  -- CrÃ©er l'entrÃ©e fondateur
  INSERT INTO founders (user_id, invitation_id, founder_type, founder_number)
  VALUES (auth.uid(), inv.id, inv.founder_type, founder_num);

  -- Mettre Ã  jour l'invitation
  UPDATE invitations
  SET
    status = CASE WHEN use_count + 1 >= max_uses THEN 'accepted' ELSE status END,
    use_count = use_count + 1,
    accepted_by = auth.uid(),
    accepted_at = NOW()
  WHERE id = inv.id;

  -- Mettre Ã  jour le profil avec le rÃ´le fondateur
  UPDATE profiles
  SET role = 'fondateur', updated_at = NOW()
  WHERE id = auth.uid();

  RETURN jsonb_build_object(
    'success', true,
    'founder_number', founder_num,
    'founder_type', inv.founder_type,
    'message', inv.personal_message
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Fonction pour vÃ©rifier un code sans l'utiliser
CREATE OR REPLACE FUNCTION verify_invitation_code(invitation_code TEXT)
RETURNS JSONB AS $$
DECLARE
  inv RECORD;
BEGIN
  SELECT invited_name, founder_type, personal_message, expires_at
  INTO inv FROM invitations
    WHERE code = invitation_code
    AND status = 'pending'
    AND (expires_at IS NULL OR expires_at > NOW())
    AND use_count < max_uses;

  IF inv IS NULL THEN
    RETURN jsonb_build_object('valid', false);
  END IF;

  RETURN jsonb_build_object(
    'valid', true,
    'invited_name', inv.invited_name,
    'founder_type', inv.founder_type,
    'personal_message', inv.personal_message,
    'expires_at', inv.expires_at
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Fonction pour gÃ©nÃ©rer un code d'invitation unique
CREATE OR REPLACE FUNCTION generate_invitation_code()
RETURNS TEXT AS $$
DECLARE
  chars TEXT := 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  result TEXT := 'ATOM-';
  i INTEGER;
BEGIN
  -- Format: ATOM-XXXX-XXXX
  FOR i IN 1..4 LOOP
    result := result || substr(chars, floor(random() * length(chars) + 1)::integer, 1);
  END LOOP;
  result := result || '-';
  FOR i IN 1..4 LOOP
    result := result || substr(chars, floor(random() * length(chars) + 1)::integer, 1);
  END LOOP;
  RETURN result;
END;
$$ LANGUAGE plpgsql;

-- Fonction pour crÃ©er une invitation (rÃ©servÃ©e au Souverain)
CREATE OR REPLACE FUNCTION create_invitation(
  p_invited_name TEXT,
  p_invited_email TEXT DEFAULT NULL,
  p_personal_message TEXT DEFAULT NULL,
  p_founder_type TEXT DEFAULT 'lumiere',
  p_contribution_note TEXT DEFAULT NULL,
  p_expires_days INTEGER DEFAULT 30
)
RETURNS JSONB AS $$
DECLARE
  new_code TEXT;
  inv_id UUID;
BEGIN
  -- VÃ©rifier que l'appelant est Souverain
  IF NOT EXISTS (
    SELECT 1 FROM profiles
    WHERE id = auth.uid() AND role = 'souverain'
  ) THEN
    RETURN jsonb_build_object(
      'success', false,
      'error', 'Seul le Souverain peut crÃ©er des invitations'
    );
  END IF;

  -- GÃ©nÃ©rer un code unique
  LOOP
    new_code := generate_invitation_code();
    EXIT WHEN NOT EXISTS (SELECT 1 FROM invitations WHERE code = new_code);
  END LOOP;

  -- CrÃ©er l'invitation
  INSERT INTO invitations (
    code, invited_name, invited_email, personal_message,
    founder_type, contribution_note, created_by,
    expires_at
  ) VALUES (
    new_code, p_invited_name, p_invited_email, p_personal_message,
    p_founder_type, p_contribution_note, auth.uid(),
    NOW() + (p_expires_days || ' days')::interval
  )
  RETURNING id INTO inv_id;

  RETURN jsonb_build_object(
    'success', true,
    'invitation_id', inv_id,
    'code', new_code,
    'expires_at', NOW() + (p_expires_days || ' days')::interval
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- 11. INDEX POUR PERFORMANCE
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE INDEX IF NOT EXISTS idx_invitations_code ON invitations(code);
CREATE INDEX IF NOT EXISTS idx_invitations_status ON invitations(status);
CREATE INDEX IF NOT EXISTS idx_founders_user_id ON founders(user_id);
CREATE INDEX IF NOT EXISTS idx_founders_founder_number ON founders(founder_number);
CREATE INDEX IF NOT EXISTS idx_founder_connections_founders ON founder_connections(founder_a, founder_b);
CREATE INDEX IF NOT EXISTS idx_founder_messages_author ON founder_messages(author_id);
CREATE INDEX IF NOT EXISTS idx_founder_messages_created ON founder_messages(created_at DESC);

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- 12. MISE Ã€ JOUR DU RÃ”LE PROFILES
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Ajouter 'fondateur' comme rÃ´le valide si pas dÃ©jÃ  fait
-- (Note: profiles.role est TEXT sans contrainte, donc pas de modification nÃ©cessaire)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- FIN DU SCRIPT D'INVITATION
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--
-- RÃ‰SUMÃ‰:
-- âœ… Table invitations: Codes d'invitation uniques avec expiration
-- âœ… Table founders: Profils Ã©tendus des membres fondateurs
-- âœ… Table founder_connections: Liens entre fondateurs
-- âœ… Table founder_messages: Cercle de communication
-- âœ… Fonctions sÃ©curisÃ©es pour gÃ©rer les invitations
-- âœ… RLS strict: Seuls les fondateurs voient le cercle
--
-- TYPES DE FONDATEURS:
-- ğŸŒŸ lumiere - Point de LumiÃ¨re International
-- ğŸ›¡ï¸ gardien - Gardien de l'Arche
-- ğŸ›ï¸ architecte - Architecte de Civilisation
-- ğŸ•¸ï¸ tisserand - Tisserand de Liens
-- ğŸ”¥ porteur - Porteur de Flamme
--
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
